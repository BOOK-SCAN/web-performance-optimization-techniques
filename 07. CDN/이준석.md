# 7.  CDN

# **📝 Contents**

## CDN을 사용하는 이유

- 성능 및 안정성 보장
    - CDN 서비스 업체들은 일반 호스팅 업체보다 많은 수의 POP를 가짐
    - 따라서 병목구간을 피해 안정적으로 사용자에게 빠르게 콘텐츠를 전달 가능
- 아키텍쳐 단순화
    - 아키텍쳐를 딱히 안바꿔도 됨
- 높은 비즈니스 수익
    - 데이터 센터를 따로 만들지 않아도 글로벌로 서비스 가능
    - 유지보수 비용이 안들고, 사용한 트래픽만큼 가격을 지불하기에 경제적

## CDN의 원리

- CDN 서비스 아키텍처
    - 사용자와 원본 서버 사이에 리버스 프록시 서버 형태로 존재함
    - 사용자와 가까운 네트워크 끝단의 서버들(에지서버)을 사용
    - 이 캐시서버에 캐시를 저장해두고 사용자에게 제공

- CDN 동작 방법
    - 사용자가 URL 입력
    - DNS에서 CDN의 도메인 반환
    - CDN의 DNS 서버에서 에지서버 IP 주소 반환
    - 캐시되어 있는 경우 바로 주고, 아니면 원본서버에서 받아와 전달

- CDN 적용 방법
    1. 원본 서버 설정 : 원본 서버의 호스트명과 IP를 DNS A 레코드에 추가
        - ex) org-www.example.com
    2. CDN에 원본 서버 등록 : CDN 서비스에 원본 서버(예: org-www.example.com) 정보를 등록
    3. DNS 변경 : 기존 도메인의 IP를 CDN 서비스 제공자의 도메인명으로 변경
    4. 보안 조치 : 원본 서버명을 예측하기 어렵게 설정해 DDoS 공격 예방

## 다중 캐시 전략

- 캐시 축출
    - 캐시 서버 용량이 초과되면 우선순위가 낮은 콘텐츠부터 삭제
    - 삭제 우선순위
    1. 오랫동안 사용되지 않은 콘텐츠
    2. 캐시 적중률이 낮은 콘텐츠
    3. 오래된 콘텐츠

- 롱테일 콘텐츠
    - 생성 초기에는 조회 수가 많지만, 이후 거의 사용되지 않는 콘텐츠
    - 콘텐츠 종류가 많거나 글로벌 사용자층이 넓을수록 발생

- 캐시 서버 간 캐시 콘텐츠 공유
    - 전 세계 분산된 엣지 서버들이 캐시를 공유해 적중률 향상
    - ICP 프로토콜 사용, 동일 POP 서버 간 캐시 공유 가능

- 다중 계층 캐시
    - 원본 서버와 에지 서버 사이에 부모 캐시 서버를 추가하여 콘텐츠 공유
    - 캐시 적중률 향상 : 부모 계층 서버가 캐시를 공유해 콘텐츠 중복 다운로드 감소
    - 원본 서버 보호 : 원본 서버로의 트래픽 감소
    - 응답 속도 개선 : 전달 경로 최적화로 사용자 응답 시간 단축

## 전달 경로 최적화

- 라스트 마일 최적화
    - 최종 사용자 요청을 가장 가까운 에지 서버로 전송하는 작업
    - DNS 기반 에지 선택
        - 사용자 위치 추정: DNS 서버의 IP 정보 활용
        - 안정적이지만 사용자가 임의로 지정한 DNS 서버에 따라 엉뚱한 에지 서버 선택 가능
    - 애니캐스트 기반 에지 선택
        - 다수 노드가 동일 IP를 공유, 가장 가까운 노드로 데이터 전송
        - 장점 : 근접 네트워크 선택, 장애 시 자동 우회
        - 단점 : ISP 정책 영향, 서버 성능 상태 반영 불가

- 프로토콜 최적화
    - TCP 최적화
        - 초기 혼잡 윈도우(CWND) 값 증가로 전송 효율 향상
        - 재전송 타임아웃(RTO) 감소로 빠른 재전송
    - TLS 연결 재사용 : 에지 서버와 원본 서버 간 TCP 연결 유지로 효율 증대

## 기타 성능 옵션

- CDN이 대신 제공하는 기본 기능
    - HTTP 압축: 텍스트 파일에 gzip 압축 적용
    - 브라우저 캐시: CDN이 콘텐츠 캐시 주기 관리
    - HTML, CSS, JS 최소화: 불필요한 공백 제거로 응답 속도 향상
    - DNS 프리페치/프리커넥트: DNS 조회와 TCP 연결 사전 실행

- 신기술 적용을 위한 CDN 기능
    - HTTP/2 & HTTP/3: 빠른 웹 통신 지원, 정적 콘텐츠 가속
    - 서버 푸시: HTTP/2의 기능으로 리소스를 미리 브라우저로 전송
    - IPv6 듀얼 스택: IPv4와 IPv6 모두 지원

# **💭 Insights**

### DNS 기반 에지 선택 VS 애니캐스트 기반 에지 선택

- DNS 기반은 CDN 의 DNS 서버에서 각각의 에지 서버들 중 사용자의 요청에 가장 적합한 서버의 ip를 제공해 직접 연결된다.
    - 장점 : 서버 상태나 부하에 따라 최적의 서버를 선택
    - 단점 : 어떤 서버가 최적이냐를 판단하는데 추가적인 시간 소요
- 애니 캐스트 기반은 사용자가 요청한 IP 주소에 대해 라우터가 BGP 등의 라우팅에 의해 자신의 위치에 가장 가까운 최적의 서버를 자동으로 선택
    - 장점 : 단순한 네트워크 거리순 라우팅이어서 지연시간 최소
    - 단점 : 중간에 과부하되는 서버가 있다면 막힐수 있음
- 그럼 뭘 더 많이 쓰나?
- 실제로 대부분의 CDN에서는 두 방식을 혼합하여 사용
- 특히, 애니캐스트 방식은 글로벌 서비스에서 더 많이 사용되며, DNS 기반 방식은 지역적인 최적화나 부하 관리가 중요한 경우에 유용
