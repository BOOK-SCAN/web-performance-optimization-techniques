# 📝 Contents

## CDN을 사용하는 이유
- CDN은 웹 캐시 서버들을 전 세계에 분산 배치하고 원본 서버의 콘텐츠들을 웹 캐시 서버에 캐시해 사용자들에게 서비스함으로써 사용자 기기나 브라우저가 웹 콘텐츠를 보다 빠르게 다운로드할 수 있도록 하는 기술
- 국내의 비즈니스가 번창하여 해외 시장에 진출하고자 할 때 생기는 서버 용량 문제를 해결하는 방법은 다음 것들이 있다.
  + 기존 서버의 용량을 증설하기
  + 해외에 직접 데이터 센터를 구축하기
  + 해외에 있는 호스팅 서비스를 이용하기
- CDN 서비스를 이용할 경우 다음과 같은 이점이 있다.
  + 성능 및 안정성 보장: CDN 서비스 업체들은 일반 호스팅 업체에 비해 많은 수의 POP를 보유하고 있으며 POP 수가 많을수록 인터넷 병목 구간을 피할 수 있어 캐시된 콘텐츠를 더 많은 사용자에게 더 빠르게 전송할 수 있다.
  + 아키텍처 단순화: CDN을 사용하면 아키텍처를 특별히 변경하지 않아도 된다.
  + 높은 비즈니스 투자 수익: CDN을 사용하면 데이터 센터를 새로 만들지 않아도 글로벌 시장에 디지털 서비스를 쉽게 제공할 수 있다.
- CDN의 특징은 다음 것들이 있다.
  + 동적 콘텐츠 가속: CDN 제공자들은 동적 콘텐츠 가속의 문제 해결을 위해 더 많은 ISP 업체와 파트너십을 강화하고 전체 네트워크 구간을 모니터링해 고유의 알고리즘으로 최적의 경로를 선택하는 등 다양한 방식을 사용하고 있다.
  + 프런트엔드 최적화: 원본 서버에서 최적화를 구현하지 않아도 손쉽게 웹 사이트 로딩 속도를 향상시킬 수 있는 방안을 제공한다.
  + 동영상 또는 라이브 스트리밍 서비스: CDN의 VOD 서비스를 이용하여 동영상을 수월하게 제공할 수 있다.
  + 클라우드 보안: 대형 CDN 업체들은 기업들의 요구에 맞춰 보안 분야까지 사업 영역을 확대하고 디도스 방어 서비스, 웹 어플리케이션 방화벽 서비스 등을 제공한다.
- 대표적 CDN 업체: Akamai Technologies, CDNetworks, Amazon CloudFront, Limelight Networks, Microsoft Azure, Cloudflare 등

## CDN의 원리
- CDN 업체들은 대부분 사용자 스스로 CDN 설정을 수정하고 관리하도록 권장하기 때문에, 우리가 CDN의 기본 아키텍처와 동작 원리를 잘 이해한다면 설정하고 관리하는 데 큰 도움이 될 것이다.

### CDN 서비스 아키텍처
- CDN 서비스는 리버스 프록시 서버 형태로 존재한다.
- CDN 업체들은 전 세계에 또는 특정 지역에 여러 개의 POP을 만들어 에지 노드들을 구성한다.
  + 에지 서버: 네트워크의 끝단, 사용자와 가장 가까운 곳에 위치한 서버들
  + CDN 업체가 자체 네트워크를 구축하는 방법에 차이가 있지만, 어느 쪽을 사용하든 사용자에게 빠르고 안정적인 서비스를 제공하려면 가능한 많은 위치에 많은 수의 에지 노드가 필요하다.

### CDN 동작 방법
- 브라우저가 웹 사이트 IP 주소를 조회할 떄 호스팅 조직의 DNS 서버는 자사 서버 IP 대신 CDN 서비스 제공자의 도메인명을 반환한다.
- 사용자 브라우저는 CDN 서비스 제공자의 DNS 서버에 해당 도메인명에 대한 IP를 다시 요청하고 CDN 업체의 DNS 서버는 사용자와 가장 가까이 위치한 에지 서버의 IP를 최종 반환한다.
- 에지 서버의 IP를 받은 브라우저는 사용자 요청을 그 에지 서버로 보낸다.
- 에지 서버는 캐시된 콘텐츠를 사용자에게 빠르게 반환하거나 캐시되어 있지 않은 경우 원본 서버에서 콘텐츠를 받아와서 캐시한 후 브라우저에 응답한다.

### CDN 적용 방법
- 일반적으로 CDN 서비스를 사용하려면 다음과 같은 절차를 거친다.
  1. 원본 서버로 사용할 호트스명과 IP를 네임 서버의 A 레코드로 추가한다.
  2. CDN 설정에 원본 서버의 호스트명으로 org-www.example.com을 등록한다.
  3. 마지막으로 기존 도메인명에 부여되어 있던 IP 정보를 CDN 서비스 제공자의 도메인명으로 변경해야 한다.

## 다중 캐시 전략
- 다중 캐시: 사용자와 서버 사이에 여러 개의 캐시 계층을 주어 캐시 효율을 극대화하는 기술

### 캐시 축출
- 캐시 축출: 용량이 일정 한계치에 도달하면 캐시된 콘텐츠에 우선순위를 부여해 낮은 순위의 콘텐츠부터 삭제하는 것
- 우선순위를 부여하는 정책에는 공통적으로 아래와 같은 사항들이 적용된다.
  + 일정 기간 캐시 적중이 없었던 콘텐츠
  + 캐시 적중률이 미미한 콘텐츠
  + 더 오래된 콘텐츠

### 롱테일 콘텐츠
- 특정 콘텐츠가 캐시에서 축출되는 주 요인은 물리적 한계뿐만 아니라 그 콘텐츠의 캐시 적중률이 매우 낮기 때문이다.
- 롱테일 콘텐츠: 생성 초기 많이 조회되다가 짧은 시간이 흐른 후 조회 수가 확 줄고 이후 거의 조회되지 않은 콘텐츠
- 웹 사이트 내에 콘텐츠 종류가 많을수록 그리고 사용자층이 여러 국가에 넓게 퍼져 있을수록 심화된다.

### 캐시 서버 간 캐시 콘텐츠 공유
- 기본적으로 사용자가 많을수록 캐시 적중률이 높아지는 것은 사실이지만, 실제로 한 콘텐츠가 특정 에지 서버에만 캐시되어 있는 경우는 거의 적고 그러므로 하나의 에지 서버를 기준으로 실제 사용자 방문에 의한 캐시 적중률은 매우 낮다고 볼 수 있다.
- 전 세계에 분산된 에지 서버들 사이에서 마치 하나의 서버를 사용하는 것처럼 공유될 수 있다면 해당 콘텐츠의 캐시 적중률이 높아질 것이다.
- 이러한 에지 서버 간 캐시 공유는 ICP와 같은 특별한 프로토콜을 사용해 빠르게 이루어져야 한다.

### 다중 계층 캐시
- 다중 계층 캐시: 에지 서버들과 원본 서버 사이에 추가 캐시 서버 계층(부모 계층)을 두어 같은 콘텐츠를 여러 번 캐시하는 방식
- 추가 캐시 계층을 통한 공유 효과를 얻으려면 다음과 같은 조건을 만족해야 한다.
  + 부모 계층을 원본 서버에 가까이 존재해야 한다.
  + 부모 계층의 캐시 서버 수가 자식 계층의 캐시 서버 수보다 훨씬 적어야 한다.
- 조건을 만족할 때 다충 계층 캐시를 사용하면 다음과 같은 효과를 얻을 수 있다.
  + 캐시 적중률 향상
    - 부모 계층의 에지 서버에 콘텐츠가 캐시되면 자식 계층의 나머지 에지 서버들은 원본 서버에 콘텐츠를 요청할 필요 없이 부모 계층에서 캐시된 콘텐츠를 받아 서비스한다.
    - 부모 계층 캐시 서버들의 캐시 적중률이 높아지고, 이에 따라 캐시된 콘텐츠가 캐시 서버에서 축출될 확률도 낮아진다.
  + 과도한 트래픽으로부터 원본 서버 보호
  + 사용자 요청에 대한 응답 속도 향상

## 전달 경로 최적화
- 전달 경로를 최적화 할 때 경로를 라스트 마일, 미들 마일, 퍼스트 마일 세 구간으로 나눌 수 있다.
  + 라스트 마일: 최종 사용자와 CDN 에지 서버 간 구간
  + 미들 마일: CDN 네트워크 구간
  + 퍼스트 마일: 에지 서버와 원본 서버와의 구간

### 라스트 마일 최적화
- 최종 사용자 요청을 사용자와 가장 가까운 곳에 있는 에지 서버로 전송하는 일
- 크게 두 가지로 나눌 수 있다.

#### DNS 기반 에지 선택
- CDN 서비스 업체들은 평소 자사 에지 서버들의 상태와 네트워크 상황을 모니터링하고 있다가 자사 DNS 서버로 특정 웹 사이트 도메인명에 대한 쿼리가 요청되면 사용자의 로컬 DNS와 가장 가깝고 사용량이 적은 에지 서버의 IP를 반환한다.
- 하지만 사용자가 특정 DNS 서버를 지정해 사용하는 경우 엉뚱한 곳의 에지 서버가 선택될 수 있다.

#### 애니캐스트 기반의 에지 선택
- 우리가 접속하는 웹 사이트는 대부분 유니캐스트를 사용한다.
  + 유니캐스트: 보내는 측과 받는 측이 1:1로 통신하는 방식으로써 보내는 측은 받는 측 주소를 정확히 알고 메시지를 전송해야하는 것
  + 멀티캐스트: 1:N 통신 방식으로 보내는 측은 받은 노느들의 그룹 주소 또는 포트를 알고 있어야 한다.
  + 브로드캐스트: 불특정 다수에게 메시지를 전송하는 방식
- 애니캐스트도 1:1 전송 방식이지만 유니캐스트와는 다르게 다수 노드가 같은 IP 주소를 가진다. 그리고 보내는 측이 그 IP 주소로 메시지를 보낼 때 네트워크상 가장 가까운 노드를 선택해 보내는 방식
- 실제 사용자와 가장 가까운 네트워크의 에지 서버가 선택되며 서버 장애 시 자동 우회되므로 가용성도 어느 정도 보장된다는 장점이 있다.
- 라스트 마일 구간에서 최적의 에지 서버를 찾았다면 퍼스트 마일에서는 최적의 원본 서버를 찾아야 한다. 
- 일반적으로 트래픽 분산은 다음과 같은 방식으로 수행된다.
  + 비율, 지역, 성능에 따른 트래픽 분산
- 데이터 센터가 선택되면 에지 서버가 사용자 요청을 선택된 데이터 센터로 전송한다.
  + 주의할 점은 한 사용자 요청이 어떤 하나의 데이터 센터에서 처리되었다면 그 사용자의 이어지는 요청들이 모두 똑같은 데이터 센터에서 처리되어야 한다는 것
- 미들 마일 전달 경로 최적화는 사용자 요청을 받은 에지 서버와 원본 서버 간 가장 빠른 네트워크 경로를 찾아내는 작업이다.

### 프로토콜 최적화
- 프로토콜 최적화는 한번에 많은 트래픽을 보낼 수 있도록 길을 넓히는 작업. 경로 최적화와 병행되어야 한다.
- 웹 트래픽은 HTTP을 기반으로 3-way handshakes 방식으로 데이터 패킷을 주고 받기 떄문에 한번에 가능한 많은 패킷을 보내는 것이 유리하다. 그러나 받는 측이 수용할 수 없는 양의 데이터를 한꺼번에 보내 데이터가 유실되면 보내는 측에서 다시 유실 데이터를 전송해야 하므로 네트워크 자원을 낭비한다. 따라서 보내는 측은 항상 받는 측의 윈도우 사이즈(수신 가능한 데이터 크기) 값을 고려해 그보다 더 적은 양의 데이터를 보내야 한다.

#### TCP 최적화
- TCP는 혼잡 상황을 제어하기 위해 느린 시작이라는 알고리즘을 사용한다.
  + 느린 시작: 송신 측이 전송을 시작할 때 적은 양의 데이터부터 전송하는 것
  + 혼잡 윈도우: 느린 시작으로 전송하는 데이터의 크기
- 느린 시작은 다음과 같이 설명할 수 있다.
  1. 초기 혼잡 윈도우에 정해진 만큼 데이터 패킷을 전송한다.
  2. 문제가 없으면 혼잡 윈도우 값은 제곱으로 증가한다.
  3. 네트워크가 혼잡해 재전송 타임아웃이 발생하면 현재 혼잡 윈도우의 절반 값으로 임계치가 설정되고 처음부터 다시 전송을 시작한다.
  4. 이후 혼잡 윈도우 값이 정해진 임곗값보다 커지면 혼잡 회피를 위해 혼잡 윈도우 값은 제곱이 아닌 선형으로 증가한다.
  5. 이후 임곗값은 패킷 유실이나 네트워크 에러, 중복 응답 등에 따라 다른 방식으로 계산되어 장해진다.
- CDN 구간에서의 TCP 최적화
  + 미들 마일의 네트워크가 잘 관리되고 양호하다는 전제가 있어야 한다.
    + 첫 번째로 초기 혼잡 윈도우 값(3MSS)을 늘려 한번에 많은 데이터 패킷을 보낼 수 있게 한다.
    + 두 번째로 RTO 값을 낮춰 실패한 패킷을 빠르게 전송한다.

#### TLS 종료와 TCP 연결 재사용
- CDN 서비스를 사용하면 최종 사용자는 CDN과 TCP 연결을 맺고 CDN은 원본 서버와 또 다른 TCP 연결을 생성한다. 그러나 연결을 한 번 더 생성하는 것은 비효율적이므로 CDN 서비스 제공자들은 원본 서버와의 TCP 연결을 바로 끊지 않고 이미 생성된 연결들을 재사용한다.

## 기타 성능 옵션
### CDN이 대신 제공하는 기본 기능
#### HTTP 압축
- 텍스트 파일 전송 시에 압축은 매우 중요한 역할을 하며 CDN 서비스를 사용 중이라면 에지 서버는 기본적인 텍스트 파일 포맷에 gzip 압축을 적용해 브라우저로 전송한다.
  + 대부분 브라우저는 gzip 압축 방식을 지원한다.
- CDN이 제공하는 압축은 에지 서버와 브라우저 네트워크 구간에만 적용된다.

#### 브라우저 캐시
- 사용자가 웹 사이트를 재방문할 때 브라우저는 그간 콘텐츠가 변경되었는지 검사하고 변경된 파일만 다운로드한다.
- 브라우저 캐시는 쉽고 확실하게 성능을 향상하는 기능이지만 동작 방식을 알지 못해서 잘못 사용하는 경우가 많다.
- 대부분 CDN 업체는 브라우저를 위한 Cache-Control을 어떻게 처리할 것인지 옵션을 제공한다. 다음과 같은 것들이 있다.
  + CDN에 설정한 TTL 값을 그대로 사용
  + 서버에서 응답한 헤더를 그대로 브라우저로 전송
  + CDN에 설정한 캐시 주기와 서버 응답 헤더의 캐시 주기 중 더 길게 남은 값을 사용
  + CDN에 설정한 캐시 주기와 서버 응답 헤더의 캐시 주기 중 더 짧게 남은 값을 사용
  + 브라우저 캐시를 사용하지 않음

#### HTML, CSS, 자바스크립트 최소화
- CDN 업체의 에지 서버에서는 응답 콘텐츠에서 공백, 주석 등을 제거해 캐시한 후 같은 요청에 대해서 이미 최적화된 콘텐츠를 제공함으로써 사용자에게 응답하는 속도를 높일 수 있다.

#### DNS 프리페치와 프리커넥트
- 웹 개발자는 <link> 태그를 사용해 브라우저에 성능 개선 힌트를 줄 수 있다. 
- <link>를 삽입하기 어렵다면 CDN에서 제공하는 DNS 프리페치 기능을 사용할 수 있다.
  + 다음과 같은 Link 헤더를 주가해 도메인에 IP를 미리 조회한다.
```
Link: <http://image.example.com>; rel=dns-prefetch>
```

### 신기술 적용을 위한 CDN 기능
- HTTP/2와 HTTP/3
  + CDN 네트워크에서 HTTP/2는 대부분 브라우저와 에지 서버 사이 구간에서만 캐시할 수 있는 정적 콘텐츠를 가속하는 데 사용한다. 원본 서버의 HTTP/2 지원 여부와 상관없이 적용 가능하다.
  + HTTP/3는 아직 CloudFlare에서만 유일하게 지원하고 있으나 주요 CDN 업체들도 지원할 것으로 예상된다.
- 서버 푸시
  + CDN 설정에 HTTP/2 기능을 추가해도 즉시 사용할 수 없는 조금 특별한 기능
  + 서버 푸시: 리소스에 대한 다운로드 요청을 보내지 않아도 필요한 자원을 미리 전송해주는 기능
  + 미리 푸시하려면 푸시 대상을 지정하는 일련의 작업이 필요하다. 서버 푸시는 이 푸시 대상을 지정하는 방식에 따라 크게 두 가지로 구분한다.
    1. CDN에 푸시할 자원들을 미리 지정하는 방식 - 푸시할 자원들을 미리 지정하면 CDN은 HTML 요청을 받는 즉시 푸시 객체를 브라우저에 보낸다.
    2. 웹 페이지에 푸시할 리소스를 태그로 지정하는 방식 - CDN 에지는 원본 서버에서 응답받은 HTML에 preload로 지정된 리소스가 있을 경우 미리 캐시된 그 리소스를 푸시한다.

#### IPv6 듀얼 스택
- 사물 인터넷 시대에는 무한대에 가까운 IP 주소를 제공할 수 있는 생성 메커니즘이 절대적으로 필요하다.
- 이러한 IP 주소의 필요성을 인식하여 IPv6가 발표되었다. IPv6의 주요 장점은 다음과 같다.
  + 128비트 길이를 사용해 방대한 주소를 생성할 수 있다. 별도의 네트워크 주소 변환 장치가 필요하지 않다.
  + IPv4 헤더에서 불필요한 부분을 제외해 간소화했다. 보다 빠르게 패킷을 처리 가능하다.
  + 자동 구성 기능을 제공해 훨씬 단순하며 관리하기 쉽다.
  + IPv6의 자동 네트워킹 기능을 단말기를 움직일 때마다 고유 IP를 자동으로 설정한다.
  + 등급별, 서비스별로 패킷을 구분할 수 있어 품질을 보장할 수 있다.
  + 보안 기능이 강화되었다.

# 💭 Insights
## CDN 사업자의 저작권 침해 책임?
- CDN 업체는 세계 주요 도시에 데이터 센터들을 구축하고 이를 중심으로 POP들을 구성하거나 자체적인데이터 센터 없이 주요 ISP 데이터 센터나 POP 내 서버들을 임대하여 사용하는 경우도 있다고 한다. 이 내용에서 CDN 서비스의 데이터 관련 법적 문제는 없을까? 하는 의문을 갖고 검색하던 중, CDN 서비스가 불법 저작물 유통에 악용이 된다는 사실을 알게 되었다.

> CDN은 콘텐츠 복사본을 최종 사용자와 지리적으로 가까운 ‘데이터 임시 저장 서버(캐시 서버)’에 분산해, 사용자의 콘텐츠 접근성을 효율화한 서비스다. 해외 불법사이트가 CDN 서비스를 이용하는 경우 원본 서버는 해외에 존재하지만 실제 접속할 때는 캐시 서버로 연결돼 국제 관문망에서 접속 차단을 해도 국내 서버에 복제된 웹사이트를 이용할 수 있다는 문제가 있었다.

> 특히 실제 IP 주소가 드러나지 않게 되는 CDN의 특징은 불법 콘텐츠 공유 사이트 운영자들이 실제 서버 위치와 자신의 신원정보를 은닉할 수 있는 수단으로 유용하게 활용되고 있다. 작년 세간을 떠들썩하게 했던 ‘누누티비’ 사이트 역시 CDN을 활용하여 불법 콘텐츠를 유통하였는데, 당시까지 ‘누누티비’로 인한 저작권 침해 피해액만도 5조 원에 달하는 것으로 추산되었다. 불법 콘텐츠의 유통으로 인한 막대한 피해 발생에 CDN도 관여되어 있는 상황인 것이다.

> CDN이 불법 콘텐츠의 유통 및 확산의 수단으로 널리 활용되고 있다는 단지 그 이유만으로는 CDN에게 저작권 침해 책임을 추궁할 수는 없다. 우선 CDN 사업자는 불법 콘텐츠 복제, 전송행위의 주체가 아니다. 또한 CDN은 기본적으로 분산된 서버 네트워크를 기초로 콘텐츠를 빠르고 안전하게 전달하는 유용한 ‘기술’일 뿐이기 때문이다. 나아가 CDN은 보편적, 가치중립적인 성격을 가진 서비스로서 원칙적으로 콘텐츠의 적법성 여부와는 관련이 없고, 실제로 대다수의 적법한 콘텐츠의 유통에도 널리 활용되고 있다는 점도 CDN 사업자의 책임을 부인하는 근거가 될 수 있다.
그런데 미국, 유럽, 일본 등 세계 각국에서는 CDN 사업자에게 저작권 침해 책임을 묻는 소송이 연이어 발생하고 있다.
...중략...
그런데 CDN은 원본 서버에 저장된 콘텐츠를 자신의 에지 서버에 복제하여 이용자에게 전송한다는 기술적 특징을 가지므로, CDN 사업자들은 불법 콘텐츠의 복제와 전송 행위에 웹 호스팅 업체나 VPN 업체들보다 더 직접적으로 개입 또는 기여하고 있다고 볼 여지가 있다. 
또한 CDN 사업자들은 불법 콘텐츠 공유 사이트 운영자들과 계약을 체결하여 이들에게만 CDN 서비스를 제공하므로, 해당 운영자들이 저작권 침해행위를 하는 경우 해당 운영자들이 제공하는 콘텐츠만 선별하여 복제와 전송을 중단시키는 기술도 당연히 보유하고 있을 것으로 추정된다. 나아가 해당 운영자들과의 계약을 해지하여 이들이 더 이상 자신의 CDN 서비스를 사용하지 못하게 할 수 있는 권리도 보유하고 있을 것으로 보인다. 
만약 CDN 사업자들이 위와 같이 저작권 침해를 중단시킬 수 있는 기술과 권리를 보유하고 있음에도 만연히 이를 중단시키지 않아 왔던 것이라면, 이 때문에 더 많은 불법 콘텐츠 공유 사이트 운영자들이 CDN 서비스에 몰려 들게 되었고, 이로써 CDN 사업자들은 더 많은 고객을 유치하여 수익을 얻을 수 있었다는 주장도 가능해질 것이다.

> 불법 사이트를 운영하기 위해 ①서버에 접속할 때는 다중가상사설망(VPN)으로 인터넷주소(IP)를 바꿨고 ②거래를 위해서는 해외 신용카드와 해외 가상자산 거래소를 이용했다. ③'오케이툰'을 운영할 때는 웹툰 플랫폼 작품을 무단 복제하기 위해 불특정 다수로부터 계정을 모아 도용하기도 했다.
영상 공유 사이트였던 ④누누티비와 티비위키는 개인 간 공유(P2P) 스트리밍 기술을 쓰기도 했다. P2P 스트리밍은 한 사용자의 개인용컴퓨터(PC)에서 동일한 영상을 보고 있는 다른 이용자의 PC로 조각 파일을 배포하는 기술로 영상 전송 비용을 절약할 수 있다.

#### 정리
- CDN은 불법 콘텐츠 공유에 활용되며, CDN 업체도 이를 방치한 책임으로 비판받고 법적 문제가 제기되고 있다. 그러나 불법 사이트 운영자들은 VPN, 해외 결제, P2P 기술 등 다양한 수단을 병행해 추적을 회피하고 있어 잡기 어려운 것이다.

#### 출처
- https://www.hankookilbo.com/News/Read/A2024121616430004078
- https://www.kcopa.or.kr/lay1/bbs/S1T233C496/A/88/view.do?article_seq=5722&cpage=1&rows=10&condition=&keyword=
- https://m.edaily.co.kr/News/Read?newsId=03204566638859400&mediaCodeNo=257
